<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seller Viewer ‚Äî TERRITORY ‚Üí POS NAME ‚Üí MOBILE_NUMBER</title>
  <style>
    :root{--bg:#fff;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--radius:16px;--shadow:0 1px 2px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06);--space:14px}
    html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--fg)}
    .container{max-width:720px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    header .inner{display:flex;gap:10px;align-items:center;padding:12px}
    h1{font-size:16px;margin:0;font-weight:700}
    .card{border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);background:#fff}
    .content{padding:var(--space)}
    .row{display:grid;gap:var(--space)}
    label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
    select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:14px}
    button{cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    .metrics{display:grid;grid-template-columns:1fr;gap:var(--space)}
    @media(min-width:640px){.metrics{grid-template-columns:1fr 1fr}}
    .metric{border:1px solid var(--border);border-radius:12px;padding:10px}
    .metric .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .metric .v{font-weight:700}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .error{color:#b91c1c;font-size:13px;white-space:pre-line}
  </style>
</head>
<body>
<header>
  <div class="inner container">
    <div style="font-size:20px">üìÑ</div>
    <h1>–§–∏–ª—å—Ç—Ä Seller (–±–µ—Ä—ë—Ç —Ñ–∞–π–ª –∏–∑ –∫–æ—Ä–Ω—è —Å–∞–π—Ç–∞)</h1>
    <div class="muted" style="margin-left:auto">TERRITORY ‚Üí POS NAME ‚Üí MOBILE_NUMBER</div>
  </div>
</header>

<main class="container">
  <!-- –°—Ç–∞—Ç—É—Å / —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
  <section class="card">
    <div class="content row">
      <div class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–π–ª–∞: <code id="file-url"></code></div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="reload">üîÑ –ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª</button>
        <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
      <div class="muted" id="rows-count"></div>
      <div class="error" id="error"></div>
    </div>
  </section>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <section class="card" style="margin-top:12px;">
    <div class="content row">
      <div class="row">
        <label for="territory">TERRITORY</label>
        <select id="territory" disabled>
          <option value="">–û–∂–∏–¥–∞—é —Ñ–∞–π–ª‚Ä¶</option>
        </select>
      </div>
      <div class="row">
        <label for="pos">POS NAME (—Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞)</label>
        <select id="pos" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY</option>
        </select>
      </div>
      <div class="row">
        <label for="mobile">MOBILE_NUMBER</label>
        <select id="mobile" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME</option>
        </select>
      </div>
    </div>
  </section>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
  <section class="card" style="margin-top:12px;">
    <div class="content">
      <div id="result-empty" class="muted">–í—ã–±–µ—Ä–∏—Ç–µ TERRITORY ‚Üí POS NAME ‚Üí MOBILE_NUMBER, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
      <div id="result" style="display:none;">
        <div class="muted">MOBILE_NUMBER</div>
        <div id="mobile-value" style="font-weight:700;font-size:16px;">‚Äî</div>
        <div class="divider"></div>
        <div class="metrics" id="metrics"></div>
      </div>
    </div>
  </section>

  <p class="muted" style="text-align:center;margin-top:10px;">
    –ü–æ–ª–æ–∂–∏—Ç–µ Excel –≤ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞ –ø–æ–¥ –∏–º–µ–Ω–µ–º <b>seller.xlsx</b>. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ø–æ <b>http(s)://</b> (–Ω–µ <code>file://</code>).
  </p>
</main>

<!-- XLSX –ø–∞—Ä—Å–µ—Ä -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // === –ù–ê–°–¢–†–û–ô–ö–ò: –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –æ—Ç –ö–û–†–ù–Ø —Å–∞–π—Ç–∞ ===
  const EXCEL_URL = '/seller.xlsx'; // / = –∫–æ—Ä–µ–Ω—å –¥–æ–º–µ–Ω–∞

  // –ú–µ—Ç—Ä–∏–∫–∏ (—Ç–æ—á–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫):
  const METRIC_COLUMNS = [
    'MOBILE_NUMBER','–¢–ü –ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª','UpSell 01-19.08.25','TV 01-19.08.25','USIM 01-19.08.25',
    '–ú—ñ–≥—Ä–∞—Ü—ñ—ó 01-19.08.25','–ù–ö–ü 01-19.08.25','Sim on the fly 01-19.08.25','SuperPower 01-19.08.25',
    '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü jet 01-19.08.25','EN 01-19.08.25','MNP 01-19.08.2025','Total –æ–ø–µ—Ä–∞—Ü—ñ—ó JET',
    '–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç','–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü ussd 01-19.08.25'
  ];
  const REQUIRED_KEYS = ['TERRITORY','POS NAME',...METRIC_COLUMNS];

  // –≠–ª–µ–º–µ–Ω—Ç—ã
  const elFileUrl = document.getElementById('file-url');
  const elReload  = document.getElementById('reload');
  const elReset   = document.getElementById('reset');
  const elRows    = document.getElementById('rows-count');
  const elErr     = document.getElementById('error');

  const selT = document.getElementById('territory');
  const selP = document.getElementById('pos');
  const selM = document.getElementById('mobile');

  const resEmpty = document.getElementById('result-empty');
  const resBox   = document.getElementById('result');
  const elMobile = document.getElementById('mobile-value');
  const elMetrics= document.getElementById('metrics');

  elFileUrl.textContent = EXCEL_URL;

  let ROWS = [];

  // –£—Ç–∏–ª–∏—Ç—ã
  const norm = v => (v==null?'':String(v)).trim();
  const esc  = s => String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  const uniqSorted = arr => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'uk',{numeric:true,sensitivity:'base'}));
  const setOptions = (sel, values, ph) => { sel.innerHTML=['<option value="">'+esc(ph)+'</option>'].concat(values.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`)).join(''); sel.disabled=values.length===0; };
  const setRowsCount = n => elRows.textContent = n ? `–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${n.toLocaleString('uk-UA')}` : '';
  const showError = msg => elErr.textContent = msg || '';

  // –†–µ–Ω–¥–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  function showResult(row){
    if(!row){ resBox.style.display='none'; resEmpty.style.display=''; return; }
    resEmpty.style.display='none'; resBox.style.display='';
    elMobile.textContent = norm(row['MOBILE_NUMBER']) || '‚Äî';
    const keys = METRIC_COLUMNS.filter(k=>k!=='MOBILE_NUMBER');
    elMetrics.innerHTML = keys.map(k=>`<div class="metric"><div class="k">${esc(k)}</div><div class="v">${esc(norm(row[k])||'0')}</div></div>`).join('');
  }

  function rebuildPos(){
    const t = norm(selT.value);
    const list = uniqSorted(ROWS.filter(r=>norm(r['TERRITORY'])===t).map(r=>norm(r['POS NAME'])));
    setOptions(selP,list,t?'–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É':'–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY');
    setOptions(selM,[], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME');
    showResult(null);
  }

  function rebuildMobile(){
    const t = norm(selT.value), p = norm(selP.value);
    const list = uniqSorted(ROWS.filter(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p).map(r=>norm(r['MOBILE_NUMBER'])));
    setOptions(selM,list,p?'–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä':'–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME');
    showResult(null);
  }

  function onSelectChanged(){
    const t = norm(selT.value), p = norm(selP.value), m = norm(selM.value);
    if(!t || !p || !m){ showResult(null); return; }
    const row = ROWS.find(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p && norm(r['MOBILE_NUMBER'])===m) || null;
    showResult(row);
  }

  selT.addEventListener('change', rebuildPos);
  selP.addEventListener('change', rebuildMobile);
  selM.addEventListener('change', onSelectChanged);
  elReset.addEventListener('click', ()=>{
    if(!ROWS.length) return;
    setOptions(selT, uniqSorted(ROWS.map(r=>norm(r['TERRITORY']))), '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é');
    setOptions(selP, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY');
    setOptions(selM, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME');
    selT.value=selP.value=selM.value='';
    showResult(null);
  });
  elReload.addEventListener('click', ()=>loadExcel(true));

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–æ—Ä–Ω—è —Å–∞–π—Ç–∞
  async function loadExcel(){
    showError(''); setRowsCount(0); ROWS = [];

    if (location.protocol === 'file:') {
      showError('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–∞–∫ file://\\n–ù—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ http(s):// (—á–µ—Ä–µ–∑ —Ö–æ—Å—Ç–∏–Ω–≥ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä).');
      return;
    }

    try{
      const url = EXCEL_URL + (EXCEL_URL.includes('?') ? `&v=${Date.now()}` : `?v=${Date.now()}`); // –∫—ç—à-–±–∞—Å—Ç–µ—Ä
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok){
        const txt = await res.text().catch(()=> '');
        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${EXCEL_URL} (HTTP ${res.status}). ${txt ? '–û—Ç–≤–µ—Ç: ' + txt.slice(0,200) : ''}`);
      }
      const buf = await res.arrayBuffer();
      const wb  = XLSX.read(buf, { type:'array' });

      const seller = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='seller');
      if(!seller) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç 'Seller' –≤ Excel-—Ñ–∞–π–ª–µ.");

      const ws = wb.Sheets[seller];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      if(!json.length) throw new Error("–õ–∏—Å—Ç 'Seller' –ø—É—Å—Ç–æ–π.");

      const cols = Object.keys(json[0]||{});
      const missing = REQUIRED_KEYS.filter(k=>!cols.includes(k));
      if(missing.length) throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏: ' + missing.join(', '));

      ROWS = json;
      setRowsCount(ROWS.length);

      const terr = uniqSorted(ROWS.map(r=>norm(r['TERRITORY'])));
      setOptions(selT, terr, terr.length? '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é':'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ TERRITORY');
      selT.disabled = terr.length===0;
      setOptions(selP, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY');
      setOptions(selM, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME');
      showResult(null);
    }catch(e){
      console.error(e);
      showError(e.message || '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å, –¥–æ—Å—Ç—É–ø –∏ –¥–æ–º–µ–Ω/–ø—Ä–æ—Ç–æ–∫–æ–ª.');
      setOptions(selT, [], '–û–∂–∏–¥–∞—é —Ñ–∞–π–ª‚Ä¶');
      setOptions(selP, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY');
      setOptions(selM, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME');
      showResult(null);
    }
  }

  // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
  loadExcel();
</script>
</body>
</html>
