<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seller / SalePoint / SR ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ –∏ —Å —Å–µ—Ä–≤–µ—Ä–∞</title>
  <style>
    :root{--bg:#fff;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--radius:16px;--shadow:0 1px 2px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06);--space:14px}
    html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--fg)}
    .container{max-width:820px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    header .inner{display:flex;gap:10px;align-items:center;padding:12px}
    h1{font-size:16px;margin:0;font-weight:700}
    .card{border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);background:#fff}
    .content{padding:var(--space)}
    .row{display:grid;gap:var(--space)}
    label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
    select,button,input[type=file]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:14px}
    button{cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    .metrics{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--space)}
    @media(max-width:420px){.metrics{grid-template-columns:1fr}}
    .metric{border:1px solid var(--border);border-radius:12px;padding:10px}
    .metric .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .metric .v{font-weight:700}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .error{color:#b91c1c;font-size:13px;white-space:pre-line}
    .title{font-size:13px;font-weight:700;margin-bottom:6px}
    .drop{border:2px dashed var(--border);border-radius:12px;padding:16px;text-align:center}
    .drop.drag{border-color:#94a3b8;background:#f8fafc}
    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –¢–¢ */
    .metric.active-tt{background:#ecfdf5;border-color:#10b981}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#ecfdf5;color:#065f46;font-size:11px;border:1px solid #10b981;margin-left:6px}
    .mode{font-size:12px;padding:6px 10px;border:1px dashed var(--border);border-radius:10px}
  </style>
</head>
<body>
<header>
  <div class="inner container">
    <div style="font-size:20px">üìÑ</div>
    <h1>–§–∏–ª—å—Ç—Ä Seller / SalePoint / SR ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ –∏ —Å —Å–µ—Ä–≤–µ—Ä–∞</h1>
    <div class="muted" style="margin-left:auto">TERRITORY ‚Üí POS NAME ‚Üí MOBILE_NUMBER</div>
  </div>
</header>

<main class="container">
  <!-- –ò—Å—Ç–æ—á–Ω–∏–∫/—Ä–µ–∂–∏–º -->
  <section class="card">
    <div class="content row">
      <div class="mode" id="mode-text">–†–µ–∂–∏–º: ‚Äî</div>
      <div class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–π–ª–∞: <code id="file-url"></code></div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="reload">üîÑ –ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª</button>
        <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
      <div class="muted" id="rows-count"></div>
      <div class="error" id="error"></div>
    </div>
  </section>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ file:// –∏–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ) -->
  <section class="card" id="local-box" style="margin-top:12px;display:none;">
    <div class="content row">
      <div class="row">
        <label for="file">–õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ Excel (*.xlsx) —Å –ª–∏—Å—Ç–∞–º–∏ <b>Seller</b> (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ), <b>SalePoint</b> (–ø–æ —Ç–æ—á–∫–µ) –∏ <b>SR</b> (–ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏). –§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚Äî —á–∏—Ç–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</label>
        <input id="file" type="file" accept=".xlsx" />
        <div id="drop" class="drop muted">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
      </div>
    </div>
  </section>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <section class="card" style="margin-top:12px;">
    <div class="content row">
      <div class="row">
        <label for="territory">TERRITORY</label>
        <select id="territory" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Ñ–∞–π–ª</option>
        </select>
      </div>
      <div class="row">
        <label for="pos">POS NAME (—Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞)</label>
        <select id="pos" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY</option>
        </select>
      </div>
      <div class="row">
        <label for="mobile">MOBILE_NUMBER</label>
        <select id="mobile" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME</option>
        </select>
      </div>
    </div>
  </section>

  <!-- –°–≤–æ–¥ –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (SR + –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º) -->
  <section class="card" style="margin-top:12px;">
    <div class="content">
      <div id="result-ter" style="display:none;">
        <div class="title">–°–≤–æ–¥ –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (SR)</div>
        <div class="muted" id="ter-caption"></div>
        <div class="metrics" id="metrics-ter-sr"></div>
        <div class="divider"></div>
        <div class="title">–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (–ø–æ —Ç–æ—á–∫–∞–º)</div>
        <div class="metrics" id="metrics-ter-ops"></div>
      </div>
    </div>
  </section>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–æ—á–∫–µ –∏ –ø–æ –Ω–æ–º–µ—Ä—É -->
  <section class="card" style="margin-top:12px;">
    <div class="content">
      <div id="result-empty" class="muted">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ñ–∞–π–ª ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY (—Å–≤–æ–¥ SR + —Å—É–º–º—ã –æ–ø–µ—Ä–∞—Ü–∏–π). –ó–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME (—Å–≤–æ–¥ —Ç–æ—á–∫–∏). –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω–æ–º–µ—Ä–∞ ‚Äî –¥–µ—Ç–∞–ª–∏ –ø–æ –Ω–æ–º–µ—Ä—É (Seller).</div>

      <div id="result-pos" style="display:none;">
        <div class="title">–ò–¢–û–ì–û –ø–æ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–µ (SalePoint) <span id="pos-pill" class="pill" style="display:none">–∞–∫—Ç–∏–≤–Ω–∞</span></div>
        <div class="muted" id="pos-caption"></div>
        <div class="divider"></div>
        <div class="metrics" id="metrics-pos"></div>
        <div class="muted" id="pos-warning" style="display:none;margin-top:8px;">–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç–µ <b>SalePoint</b>. –ü–æ–∫–∞–∑–∞–Ω—ã —Å—É–º–º—ã –ø–æ –Ω–æ–º–µ—Ä–∞–º (–∏–∑ Seller).</div>
      </div>

      <div id="result-num" style="display:none;">
        <div class="title">–î–µ—Ç–∞–ª–∏ –ø–æ –Ω–æ–º–µ—Ä—É (Seller)</div>
        <div class="muted">MOBILE_NUMBER</div>
        <div id="mobile-value" style="font-weight:700;font-size:16px;">‚Äî</div>
        <div class="divider"></div>
        <div class="metrics" id="metrics-num"></div>
      </div>
    </div>
  </section>
</main>

<!-- XLSX –ø–∞—Ä—Å–µ—Ä -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // === –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –Ω–∞ –°–ï–†–í–ï–†–ï ===
  // –ü—Ä–æ–±—É–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏: /seller.xlsx (–∫–æ—Ä–µ–Ω—å –¥–æ–º–µ–Ω–∞), seller.xlsx (—Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä GitHub Pages /repo/)
  const EXCEL_URLS = ['/seller.xlsx', 'seller.xlsx'];

  // –ü–æ—Ä—è–¥–æ–∫ –º–µ—Ç—Ä–∏–∫: –ø–æ—Å–ª–µ MOBILE_NUMBER ‚Üí 2) Total JET ‚Üí 3) –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü jet ‚Üí 4) –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü ussd ‚Üí –¥–∞–ª–µ–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
  const METRIC_COLUMNS = [
    'MOBILE_NUMBER',
    'Total –æ–ø–µ—Ä–∞—Ü—ñ—ó JET',
    '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü jet 01-19.08.25',
    '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü ussd 01-19.08.25', // ‚Üê –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –Ω–∞ 4-–µ –º–µ—Å—Ç–æ
    '–¢–ü –ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª',
    'UpSell 01-19.08.25',
    'TV 01-19.08.25',
    'USIM 01-19.08.25',
    '–ú—ñ–≥—Ä–∞—Ü—ñ—ó 01-19.08.25',
    '–ù–ö–ü 01-19.08.25',
    'Sim on the fly 01-19.08.25',
    'SuperPower 01-19.08.25',
    'EN 01-19.08.25',
    'MNP 01-19.08.2025',
    '–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'
  ];
  const REQUIRED_KEYS_SELLER = ['TERRITORY','POS NAME',...METRIC_COLUMNS];
  const OPS_KEYS = METRIC_COLUMNS.filter(k => k !== 'MOBILE_NUMBER' && k !== '–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç');

  // –î–æ–ø. –ø–æ–ª—è –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π
  const COL_ORG_ID = 'ORG ID';
  const COL_FIRST_NAME = 'First Name';
  const COL_LAST_NAME  = 'Last Name';

  // –≠–ª–µ–º–µ–Ω—Ç—ã
  const elMode  = document.getElementById('mode-text');
  const elFileUrl = document.getElementById('file-url');
  const elReload  = document.getElementById('reload');
  const elReset   = document.getElementById('reset');
  const elRows    = document.getElementById('rows-count');
  const elErr     = document.getElementById('error');
  const localBox  = document.getElementById('local-box');

  const selT = document.getElementById('territory');
  const selP = document.getElementById('pos');
  const selM = document.getElementById('mobile');

  const terBox = document.getElementById('result-ter');
  const terCap = document.getElementById('ter-caption');
  const terSr = document.getElementById('metrics-ter-sr');
  const terOps = document.getElementById('metrics-ter-ops');

  const resEmpty = document.getElementById('result-empty');
  const posBox   = document.getElementById('result-pos');
  const posCap   = document.getElementById('pos-caption');
  const posWarn  = document.getElementById('pos-warning');
  const posMetrics = document.getElementById('metrics-pos');
  const posPill = document.getElementById('pos-pill');

  const numBox   = document.getElementById('result-num');
  const elMobile = document.getElementById('mobile-value');
  const numMetrics = document.getElementById('metrics-num');

  const inpFile = document.getElementById('file');
  const drop = document.getElementById('drop');

  // –î–∞–Ω–Ω—ã–µ
  let ROWS_SELLER = []; let ROWS_SP = []; let ROWS_SR = [];

  // –£—Ç–∏–ª–∏—Ç—ã
  const norm = v => (v==null?'':String(v)).trim();
  const esc  = s => String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  const uniqSorted = arr => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'uk',{numeric:true,sensitivity:'base'}));
  const setOptions = (sel, values, ph) => { sel.innerHTML=['<option value="">'+esc(ph)+'</option>'].concat(values.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`)).join(''); sel.disabled=values.length===0; };
  const setOptionsObjects = (sel, items, ph) => { sel.innerHTML=['<option value="">'+esc(ph)+'</option>'].concat(items.map(o=>`<option value="${esc(o.value)}">${esc(o.label)}</option>`)).join(''); sel.disabled=items.length===0; };
  const setRowsCount = (nSeller,nSP,nSR) => elRows.textContent = (nSeller?`Seller: ${nSeller.toLocaleString('uk-UA')}`:'') + (nSP?` | SalePoint: ${nSP.toLocaleString('uk-UA')}`:'') + (nSR?` | SR: ${nSR.toLocaleString('uk-UA')}`:'');
  const showError = msg => elErr.textContent = msg || '';
  const toNum = v => { const s = norm(v).replace(/\s+/g,'').replace(',', '.'); const x = parseFloat(s); return isFinite(x)? x : 0; };
  const fmtInt = x => (Math.round(x)).toLocaleString('uk-UA');
  const fmtPercent = v => { const s = norm(v); if(!s) return '0%'; if(/%/.test(s)) return s; const n = toNum(s); if(!isFinite(n)) return s; const val = n <= 1 ? n * 100 : n; return `${Math.round(val)}%`; };

  function sumOps(rows){ const sums = Object.fromEntries(OPS_KEYS.map(k=>[k,0])); rows.forEach(r=>{ OPS_KEYS.forEach(k=> sums[k] += toNum(r[k])); }); return sums; }
  function sumFromSellerByPos(t,p){ const rows = ROWS_SELLER.filter(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p); return sumOps(rows); }
  function sumOpsByTerritory(t){
    const rowsSP = ROWS_SP.filter(r=>norm(r['TERRITORY'])===t);
    const rowsSL = ROWS_SELLER.filter(r=>norm(r['TERRITORY'])===t);
    const sums = {}; OPS_KEYS.forEach(k=>{ let total=0; if (rowsSP.length && rowsSP.some(r => r.hasOwnProperty(k) && norm(r[k])!=='')) { rowsSP.forEach(r=> total += toNum(r[k])); } else { rowsSL.forEach(r=> total += toNum(r[k])); } sums[k]=total; }); return sums;
  }

  function renderMetrics(container, row, skipMobile=true, fallbackFn=null){
    const keys = METRIC_COLUMNS.filter(k => !skipMobile || k !== 'MOBILE_NUMBER');
    container.innerHTML = keys.map(k => { let v = row ? norm(row[k]) : ''; if((v === '' || v == null) && typeof fallbackFn === 'function'){ const fb = fallbackFn(k); if(fb != null) v = String(fb); } const isActive = (k === '–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç') && (v === '1' || v === '1.0' || v === 'true'); return `<div class="metric${isActive? ' active-tt':''}"><div class="k">${esc(k)}</div><div class="v">${esc(v || '0')}</div></div>`; }).join('');
  }

  function showEmpty(){ resEmpty.style.display=''; posBox.style.display='none'; numBox.style.display='none'; terBox.style.display='none'; }
  function showTerritory(t){ if(!t){ terBox.style.display='none'; return; } terCap.textContent = t; terSr.innerHTML=''; const srRow = ROWS_SR.find(r=>norm(r['TERRITORY'])===t) || null; if(srRow){ const cards = [['–ü–ª–∞–Ω Total', norm(srRow['–ü–ª–∞–Ω Total'])], ['–§–∞–∫—Ç Total', norm(srRow['–§–∞–∫—Ç Total'])], ['–í–∏–∫–æ–Ω–∞–Ω–Ω—è', fmtPercent(srRow['–í–∏–∫–æ–Ω–∞–Ω–Ω—è'])]].map(([k,v])=>`<div class="metric"><div class="k">${esc(k)}</div><div class="v">${esc(v||'0')}</div></div>`).join(''); terSr.innerHTML = cards; } else { terSr.innerHTML = `<div class="muted">–ù–µ—Ç –ª–∏—Å—Ç–∞ SR –∏–ª–∏ –∑–∞–ø–∏—Å–∏ –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏.</div>`; } const sums = sumOpsByTerritory(t); terOps.innerHTML = Object.keys(sums).map(k=>`<div class="metric"><div class="k">${esc(k)}</div><div class="v">${esc(fmtInt(sums[k]))}</div></div>`).join(''); terBox.style.display=''; }

  function showPos(t,p){ terBox.style.display='none'; resEmpty.style.display='none'; posBox.style.display=''; numBox.style.display='none'; posCap.textContent = `${t || '‚Äî'} ‚Ä¢ ${p || '‚Äî'}`; const spRow = ROWS_SP.find(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p) || null; const active = (spRow && (norm(spRow['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='1' || norm(spRow['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='true')) || ROWS_SELLER.some(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p && (norm(r['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='1' || norm(r['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='true')); posPill.style.display = active? '' : 'none'; const fbSums = sumFromSellerByPos(t,p); renderMetrics(posMetrics, spRow, true, (key)=> key in fbSums ? fmtInt(fbSums[key]) : null); posWarn.style.display = spRow ? 'none' : ''; }
  function showNum(row){ if (!row){ return; } resEmpty.style.display='none'; posBox.style.display='none'; numBox.style.display=''; elMobile.textContent = norm(row['MOBILE_NUMBER']) || '‚Äî'; renderMetrics(numMetrics, row, true); }

  function rebuildPos(){ const t = norm(selT.value); const list = uniqSorted(ROWS_SELLER.filter(r=>norm(r['TERRITORY'])===t).map(r=>norm(r['POS NAME']))); const activeSet = new Set(); (ROWS_SP.length? ROWS_SP : ROWS_SELLER).forEach(r=>{ if(norm(r['TERRITORY'])===t && (norm(r['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='1' || norm(r['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='true')) activeSet.add(norm(r['POS NAME'])); }); const items = list.map(p=>{ let org=''; const sp = ROWS_SP.find(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p); if(sp && sp.hasOwnProperty('ORG ID')) org = norm(sp['ORG ID']); if(!org){ const sl = ROWS_SELLER.find(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p); if(sl && sl.hasOwnProperty('ORG ID')) org = norm(sl['ORG ID']); } const label = (activeSet.has(p)? 'üü¢ ' : '') + p + (org? ' ‚Äî ' + org : ''); return { value:p, label }; }); setOptionsObjects(selP, items, t? '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É':'–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY'); selM.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME</option>'; selM.disabled = true; if(t){ showTerritory(t); } else { terBox.style.display='none'; } numBox.style.display='none'; posBox.style.display='none'; resEmpty.style.display='none'; }

  function rebuildMobile(){ const t = norm(selT.value), p = norm(selP.value); terBox.style.display='none'; const map = new Map(); ROWS_SELLER.forEach(r=>{ if(norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p){ const num = norm(r['MOBILE_NUMBER']); if(!num) return; const fn = r.hasOwnProperty('First Name') ? norm(r['First Name']) : ''; const ln = r.hasOwnProperty('Last Name') ? norm(r['Last Name']) : ''; const name = (fn || ln) ? (`${fn} ${ln}`.trim()) : ''; const label = name ? `${num} ‚Äî ${name}` : num; if(!map.has(num)) map.set(num, { value:num, label }); }}); const items = Array.from(map.values()).sort((a,b)=>a.label.localeCompare(b.label,'uk',{numeric:true})); setOptionsObjects(selM, items, p? '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä':'–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME'); if(p){ showPos(t,p); } else { posBox.style.display='none'; } }

  function onSelectChanged(){ const t = norm(selT.value), p = norm(selP.value), m = norm(selM.value); if(!t || !p || !m) return; const row = ROWS_SELLER.find(r=>norm(r['TERRITORY'])===t && norm(r['POS NAME'])===p && norm(r['MOBILE_NUMBER'])===m) || null; showNum(row); }

  elReset.addEventListener('click', ()=>{ if(!ROWS_SELLER.length) return; setOptions(selT, uniqSorted(ROWS_SELLER.map(r=>norm(r['TERRITORY']))), '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é'); setOptions(selP, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY'); setOptions(selM, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME'); selT.value=selP.value=selM.value=''; showEmpty(); });
  elReload.addEventListener('click', ()=>{ if(location.protocol==='file:'){ elMode.textContent='–†–µ–∂–∏–º: –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª'; localBox.style.display=''; showEmpty(); } else { loadExcelFromServer(true); } });

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ ===
  async function parseFile(file){ showError(''); setRowsCount(0,0,0); ROWS_SELLER=[]; ROWS_SP=[]; ROWS_SR=[]; try{ const buf = await file.arrayBuffer(); const wb = XLSX.read(buf, { type:'array' }); const sellerName = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='seller'); if(!sellerName) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç 'Seller' –≤ Excel-—Ñ–∞–π–ª–µ."); const wsSeller = wb.Sheets[sellerName]; const jsonSeller = XLSX.utils.sheet_to_json(wsSeller, { defval:'' }); if(!jsonSeller.length) throw new Error("–õ–∏—Å—Ç 'Seller' –ø—É—Å—Ç–æ–π."); const cols = Object.keys(jsonSeller[0]||{}); const missing = REQUIRED_KEYS_SELLER.filter(k=>!cols.includes(k)); if(missing.length) throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏ (–ª–∏—Å—Ç Seller): ' + missing.join(', ')); ROWS_SELLER = jsonSeller; const spName = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='salepoint'); ROWS_SP = spName ? XLSX.utils.sheet_to_json(wb.Sheets[spName], { defval:'' }) : []; const srName = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='sr'); ROWS_SR = srName ? XLSX.utils.sheet_to_json(wb.Sheets[srName], { defval:'' }) : []; setRowsCount(ROWS_SELLER.length, ROWS_SP.length, ROWS_SR.length); const terr = uniqSorted(ROWS_SELLER.map(r=>norm(r['TERRITORY']))); setOptions(selT, terr, terr.length? '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é':'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ TERRITORY'); selT.disabled = terr.length===0; showEmpty(); }catch(e){ console.error(e); showError(e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.'); setOptions(selT, [], '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Ñ–∞–π–ª'); setOptions(selP, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY'); setOptions(selM, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME'); showEmpty(); } }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
  if(inpFile){ inpFile.addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(f) parseFile(f); }); ['dragenter','dragover'].forEach(ev=>drop && drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add('drag');})); ['dragleave','drop'].forEach(ev=>drop && drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove('drag');})); drop && drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(f) parseFile(f); }); }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ ===
  async function loadExcelFromServer(manual=false){ showError(''); setRowsCount(0,0,0); ROWS_SELLER=[]; ROWS_SP=[]; ROWS_SR=[]; const tried=[]; try{ let res=null, used=null; for(const base of EXCEL_URLS){ const url = base + (base.includes('?') ? `&v=${Date.now()}` : `?v=${Date.now()}`); tried.push(base); try{ res = await fetch(url,{cache:'no-store'}); if(res.ok){ used=base; break; } }catch(err){} } if(!res || !res.ok){ throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª. –ü—Ä–æ–±–æ–≤–∞–ª: ' + tried.join(', ')); } elFileUrl.textContent = (used||'') + ' (—É—Å–ø–µ—à–Ω–æ)'; const buf = await res.arrayBuffer(); const wb = XLSX.read(buf, { type:'array' }); const sellerName = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='seller'); if(!sellerName) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç 'Seller' –≤ Excel-—Ñ–∞–π–ª–µ."); const wsSeller = wb.Sheets[sellerName]; const jsonSeller = XLSX.utils.sheet_to_json(wsSeller, { defval:'' }); if(!jsonSeller.length) throw new Error("–õ–∏—Å—Ç 'Seller' –ø—É—Å—Ç–æ–π."); const cols = Object.keys(jsonSeller[0]||{}); const missing = REQUIRED_KEYS_SELLER.filter(k=>!cols.includes(k)); if(missing.length) throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏ (–ª–∏—Å—Ç Seller): ' + missing.join(', ')); ROWS_SELLER = jsonSeller; const spName = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='salepoint'); ROWS_SP = spName ? XLSX.utils.sheet_to_json(wb.Sheets[spName], { defval:'' }) : []; const srName = (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()==='sr'); ROWS_SR = srName ? XLSX.utils.sheet_to_json(wb.Sheets[srName], { defval:'' }) : []; setRowsCount(ROWS_SELLER.length, ROWS_SP.length, ROWS_SR.length); const terr = uniqSorted(ROWS_SELLER.map(r=>norm(r['TERRITORY']))); setOptions(selT, terr, terr.length? '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é':'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ TERRITORY'); selT.disabled = terr.length===0; showEmpty(); }catch(e){ console.error(e); showError((e&&e.message)||'–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.'); setOptions(selT, [], '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Ñ–∞–π–ª'); setOptions(selP, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY'); setOptions(selM, [], '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME'); showEmpty(); } }

  // === –ê–≤—Ç–æ-—Ä–µ–∂–∏–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
  if(location.protocol==='file:'){ elMode.textContent = '–†–µ–∂–∏–º: –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (file://)'; localBox.style.display=''; elFileUrl.textContent = '‚Äî (–ª–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)'; showEmpty(); }
  else { elMode.textContent = '–†–µ–∂–∏–º: —Å–µ—Ä–≤–µ—Ä (fetch –∏–∑ –∫–æ—Ä–Ω—è)'; localBox.style.display='none'; elFileUrl.textContent = EXCEL_URLS.join(', '); loadExcelFromServer(); }

  // –°–ª—É—à–∞—Ç–µ–ª–∏ –≤—ã–±–æ—Ä–∞
  selT.addEventListener('change', rebuildPos);
  selP.addEventListener('change', rebuildMobile);
  selM.addEventListener('change', onSelectChanged);
</script>
</body>
</html>
