<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seller / SalePoint / SR ‚Äî —Ç–µ–∫—É—â–∏–π + –ø—Ä–æ—à–ª—ã–π (–∏–∑ –∫–æ—Ä–Ω—è)</title>
  <style>
    :root{--bg:#fff;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--radius:16px;--shadow:0 1px 2px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.06);--space:14px}
    html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--fg)}
    .container{max-width:860px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    header .inner{display:flex;gap:10px;align-items:center;padding:12px}
    h1{font-size:16px;margin:0;font-weight:700}
    .card{border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);background:#fff}
    .content{padding:var(--space)}
    .row{display:grid;gap:var(--space)}
    select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .metrics{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--space)}
    @media(max-width:420px){.metrics{grid-template-columns:1fr}}
    .metric{border:1px solid var(--border);border-radius:12px;padding:10px}
    .metric .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .metric .v{font-weight:700}
    .metric .mini{margin-top:4px;font-size:11px;color:var(--muted)}
    .delta-up{color:#059669;font-weight:600}
    .delta-down{color:#b91c1c;font-weight:600}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .error{color:#b91c1c;font-size:13px;white-space:pre-line}
    .title{font-size:13px;font-weight:700;margin-bottom:6px}
    .metric.active-tt{background:#ecfdf5;border-color:#10b981}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#ecfdf5;color:#065f46;font-size:11px;border:1px solid #10b981;margin-left:6px}
    .status{font-size:12px;padding:6px 10px;border:1px dashed var(--border);border-radius:10px}
  </style>
</head>
<body>
<header>
  <div class="inner container">
    <div style="font-size:20px">üìÑ</div>
    <h1>–§–∏–ª—å—Ç—Ä Seller / SalePoint / SR ‚Äî —Ñ–∞–π–ª(—ã) –∏–∑ –∫–æ—Ä–Ω—è</h1>
    <div class="muted" style="margin-left:auto">TERRITORY ‚Üí POS NAME ‚Üí MOBILE_NUMBER</div>
  </div>
</header>

<main class="container">
  <!-- –°—Ç–∞—Ç—É—Å/–∫–Ω–æ–ø–∫–∏ -->
  <section class="card">
    <div class="content row">
      <div class="status" id="stat">–ó–∞–≥—Ä—É–∂–∞—é: /seller.xlsx (+ /seller_prev.xlsx –µ—Å–ª–∏ –µ—Å—Ç—å)‚Ä¶</div>
      <div class="muted">–¢–µ–∫—É—â–∏–π: <code>/seller.xlsx</code> ¬∑ –ü—Ä–æ—à–ª—ã–π: <code>/seller_prev.xlsx</code> (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="reload">üîÑ –ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª—ã</button>
        <button id="reset">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
      <div class="muted" id="rows-count"></div>
      <div class="error" id="error"></div>
    </div>
  </section>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <section class="card" style="margin-top:12px;">
    <div class="content row">
      <div class="row">
        <label for="territory">TERRITORY</label>
        <select id="territory" disabled>
          <option value="">–ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª‚Ä¶</option>
        </select>
      </div>
      <div class="row">
        <label for="pos">POS NAME ‚Äî ORG ID</label>
        <select id="pos" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY</option>
        </select>
      </div>
      <div class="row">
        <label for="mobile">MOBILE_NUMBER ‚Äî First Last</label>
        <select id="mobile" disabled>
          <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME</option>
        </select>
      </div>
    </div>
  </section>

  <!-- –°–≤–æ–¥ –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ -->
  <section class="card" style="margin-top:12px;">
    <div class="content">
      <div id="result-ter" style="display:none;">
        <div class="title">–°–≤–æ–¥ –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (SR, —Ç–µ–∫—É—â–∏–π ‚Üî –ø—Ä–æ—à–ª—ã–π)</div>
        <div class="muted" id="ter-caption"></div>
        <div class="metrics" id="metrics-ter-sr"></div>
        <div class="divider"></div>
        <div class="title">–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div>
        <div class="metrics" id="metrics-ter-ops"></div>
      </div>
    </div>
  </section>

  <!-- –°–≤–æ–¥ –ø–æ —Ç–æ—á–∫–µ –∏ –¥–µ—Ç–∞–ª–∏ –ø–æ –Ω–æ–º–µ—Ä—É -->
  <section class="card" style="margin-top:12px;">
    <div class="content">
      <div id="result-empty" class="muted">–ó–∞–≥—Ä—É–∑–∏–ª–∏—Å—å —Ñ–∞–π–ª—ã ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY (—Å–≤–æ–¥ SR + —Å—É–º–º—ã —Å –º–µ–ª–∫–∏–º–∏ –ø–æ–º–µ—Ç–∫–∞–º–∏ –ø—Ä–æ—à–ª–æ–≥–æ –º–µ—Å—è—Ü–∞). –ó–∞—Ç–µ–º POS NAME ‚Äî —Å–≤–æ–¥ –ø–æ —Ç–æ—á–∫–µ. –ü–æ—Å–ª–µ –Ω–æ–º–µ—Ä–∞ ‚Äî –¥–µ—Ç–∞–ª–∏.</div>

      <div id="result-pos" style="display:none;">
        <div class="title">–ò–¢–û–ì–û –ø–æ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–µ (SalePoint) <span id="pos-pill" class="pill" style="display:none">–∞–∫—Ç–∏–≤–Ω–∞</span></div>
        <div class="muted" id="pos-caption"></div>
        <div class="divider"></div>
        <div class="metrics" id="metrics-pos"></div>
        <div class="muted" id="pos-warning" style="display:none;margin-top:8px;">–ù–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ <b>SalePoint</b> —Ç–µ–∫—É—â–µ–≥–æ ‚Äî –ø–æ–∫–∞–∑–∞–Ω—ã —Å—É–º–º—ã (Seller). –î–µ–ª—å—Ç—ã ‚Äî –ø–æ –ø—Ä–æ—à–ª–æ–º—É.</div>
      </div>

      <div id="result-num" style="display:none;">
        <div class="title">–î–µ—Ç–∞–ª–∏ –ø–æ –Ω–æ–º–µ—Ä—É (Seller)</div>
        <div class="muted">MOBILE_NUMBER</div>
        <div id="mobile-value" style="font-weight:700;font-size:16px;">‚Äî</div>
        <div class="divider"></div>
        <div class="metrics" id="metrics-num"></div>
      </div>
    </div>
  </section>
</main>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // === –ø—É—Ç–∏ –≤ –∫–æ—Ä–Ω–µ ===
  const ROOT_CUR  = '/seller.xlsx';
  const ROOT_PREV = '/seller_prev.xlsx';

  // –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ (–±–µ–∑ –¥–∞—Ç –≤ –∫–æ–Ω—Ü–µ)
  const CANON_ORDER = [
    'MOBILE_NUMBER',
    'Total –æ–ø–µ—Ä–∞—Ü—ñ—ó JET',
    'Total Strong',                 // –≤–æ 2-–π –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –±–ª–æ–∫–∞ —Ç–æ—á–∫–∏ (–ø–æ—Å–ª–µ JET)
    '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü jet',
    '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü ussd',
    '–¢–ü –ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª',
    'UpSell','TV','USIM','–ú—ñ–≥—Ä–∞—Ü—ñ—ó','–ù–ö–ü','Sim on the fly','SuperPower','EN','MNP',
    '–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'
  ];
  const OPS_CANON = CANON_ORDER.filter(k => k!=='MOBILE_NUMBER' && k!=='–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç');

  // –ö–æ–ª–æ–Ω–∫–∏, –≥–¥–µ –º–µ–Ω—è–µ—Ç—Å—è –¥–∞—Ç–∞ ‚Äî –∏—â–µ–º –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
  const PREFIXED = new Map([
    ['–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü jet','–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü jet'],
    ['–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü ussd','–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –°–ü ussd'],
    ['UpSell','UpSell'],
    ['TV','TV'],
    ['USIM','USIM'],
    ['–ú—ñ–≥—Ä–∞—Ü—ñ—ó','–ú—ñ–≥—Ä–∞—Ü—ñ—ó'],
    ['–ù–ö–ü','–ù–ö–ü'],
    ['Sim on the fly','Sim on the fly'],
    ['SuperPower','SuperPower'],
    ['EN','EN'],
    ['MNP','MNP'],
  ]);
  // –°—Ç–∞—Ç–∏—á–Ω—ã–µ ‚Äî —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  const STATIC_EXACT = new Set([
    'MOBILE_NUMBER','Total –æ–ø–µ—Ä–∞—Ü—ñ—ó JET','Total Strong','–¢–ü –ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª','–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç',
    'TERRITORY','POS NAME','ORG ID','First Name','Last Name'
  ]);

  // ===== —É—Ç–∏–ª–∏—Ç—ã =====
  const norm = v => (v==null?'':String(v)).trim();
  const esc  = s => String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  const uniqSorted = arr => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'uk',{numeric:true,sensitivity:'base'}));
  const toNum = v => { const s = norm(v).replace(/\s+/g,'').replace(',','.'); const x = parseFloat(s); return isFinite(x)?x:0; };
  const fmtInt = x => (Math.round(x)).toLocaleString('uk-UA');
  const fmtPercent = v => { const s=norm(v); if(!s) return '0%'; if(/%/.test(s)) return s; const n=toNum(s); const val = n<=1? n*100 : n; return `${Math.round(val)}%`; };
  const rxEscape = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

  function buildMap(headers){
    const H=headers.slice(); const map={};
    const ilook = name => H.find(h => String(h).toLowerCase()===String(name).toLowerCase()) || null;
    STATIC_EXACT.forEach(k=>{ const h=ilook(k); if(h) map[k]=h; });
    PREFIXED.forEach((prefix,canon)=>{
      const rx=new RegExp('^'+rxEscape(prefix)+'\\b','i');
      const m = H.filter(h=>rx.test(String(h)));
      if(m.length) map[canon] = m.sort((a,b)=>String(b).length-String(a).length)[0];
    });
    return map;
  }
  const invertMap = m => Object.fromEntries(Object.entries(m).map(([k,v])=>[v,k]));

  function labelsFromMap(map, {excludeMobile=false, insertStrongSecond=false}={}){
    const order = CANON_ORDER.filter(k=>!excludeMobile || k!=='MOBILE_NUMBER');
    let labels = order.map(k=>map[k]).filter(Boolean);
    if(insertStrongSecond){
      const strong = map['Total Strong'];
      const idxJet = labels.indexOf(map['Total –æ–ø–µ—Ä–∞—Ü—ñ—ó JET']);
      if(strong && idxJet!==-1){ labels = labels.filter(l=>l!==strong); labels.splice(idxJet+1,0,strong); }
    }
    return labels;
  }

  function sumByCanon(rows, map, canonKeys){
    const sums = Object.fromEntries(canonKeys.map(k=>[k,0]));
    rows.forEach(r=> canonKeys.forEach(k=>{
      const col = map[k]; if(col) sums[k]+=toNum(r[col]);
    }));
    return sums;
  }

  function deltaTag(cur, prev){
    if(prev==null || prev==='') return '';
    const c=toNum(cur), p=toNum(prev), d=c-p;
    if(!isFinite(d) || d===0) return `<span class="mini">–±—ã–ª–æ: ${esc(prev)}</span>`;
    const cls = d>0?'delta-up':'delta-down'; const arrow = d>0?'‚ñ≤':'‚ñº';
    return `<span class="mini">–±—ã–ª–æ: ${esc(prev)} ¬∑ <span class="${cls}">${arrow} ${esc(fmtInt(Math.abs(d)))}</span></span>`;
  }

  function renderByLabelsWithPrev(container, labelsCur, getCur, findPrevByCanon, revCurMap, highlightActive=false){
    container.innerHTML = labelsCur.map(label=>{
      const curVal = getCur(label);
      const canon = revCurMap[label] || label;
      const prevVal = findPrevByCanon(canon);
      const isActive = highlightActive && canon==='–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç' && (norm(curVal)==='1'||norm(curVal)==='true'||norm(curVal)==='1.0');
      return `<div class="metric${isActive?' active-tt':''}"><div class="k">${esc(label)}</div><div class="v">${esc(curVal ?? '0')}</div>${deltaTag(curVal, prevVal)}</div>`;
    }).join('');
  }

  // ===== DOM =====
  const elErr  = document.getElementById('error');
  const elStat = document.getElementById('stat');
  const elRows = document.getElementById('rows-count');
  const btnReload = document.getElementById('reload');
  const btnReset  = document.getElementById('reset');

  const selT = document.getElementById('territory');
  const selP = document.getElementById('pos');
  const selM = document.getElementById('mobile');

  const terBox = document.getElementById('result-ter');
  const terCap = document.getElementById('ter-caption');
  const terSr  = document.getElementById('metrics-ter-sr');
  const terOps = document.getElementById('metrics-ter-ops');

  const resEmpty = document.getElementById('result-empty');
  const posBox   = document.getElementById('result-pos');
  const posCap   = document.getElementById('pos-caption');
  const posWarn  = document.getElementById('pos-warning');
  const posMetrics = document.getElementById('metrics-pos');
  const posPill  = document.getElementById('pos-pill');

  const numBox   = document.getElementById('result-num');
  const elMobile = document.getElementById('mobile-value');
  const numMetrics = document.getElementById('metrics-num');

  // ===== –î–∞–Ω–Ω—ã–µ =====
  const DS = { cur:{}, prev:{} };

  function setRowsCount(){
    const c=DS.cur, p=DS.prev;
    const curPart = (c.SELLER?`Seller[cur]: ${c.SELLER.length.toLocaleString('uk-UA')}`:'') +
                    (c.SP?` | SalePoint[cur]: ${c.SP.length.toLocaleString('uk-UA')}`:'') +
                    (c.SR?` | SR[cur]: ${c.SR.length.toLocaleString('uk-UA')}`:'');
    const prevPart = (p.SELLER||p.SP||p.SR)? ` ‚Äî prev: ` + [
      p.SELLER && `Seller: ${p.SELLER.length.toLocaleString('uk-UA')}`,
      p.SP && `SalePoint: ${p.SP.length.toLocaleString('uk-UA')}`,
      p.SR && `SR: ${p.SR.length.toLocaleString('uk-UA')}`,
    ].filter(Boolean).join(' | ') : '';
    elRows.textContent = (curPart+prevPart).trim();
  }
  const showError = msg => elErr.textContent = msg || '';

  function showEmpty(){ resEmpty.style.display=''; posBox.style.display='none'; numBox.style.display='none'; terBox.style.display='none'; }

  // === –†–µ–Ω–¥–µ—Ä—ã ===
  function showTerritory(t){
    if(!t){ terBox.style.display='none'; return; }
    const {cur,prev} = DS; terCap.textContent = t;

    // SR
    const srCur  = (cur.SR||[]).find(r=>norm(r['TERRITORY'])===t) || null;
    const srPrev = (prev.SR||[]).find(r=>norm(r['TERRITORY'])===t) || null;
    terSr.innerHTML = [
      ['–ü–ª–∞–Ω Total', srCur && srCur['–ü–ª–∞–Ω Total'], srPrev && srPrev['–ü–ª–∞–Ω Total']],
      ['–§–∞–∫—Ç Total', srCur && srCur['–§–∞–∫—Ç Total'], srPrev && srPrev['–§–∞–∫—Ç Total']],
      ['–í–∏–∫–æ–Ω–∞–Ω–Ω—è',  srCur && srCur['–í–∏–∫–æ–Ω–∞–Ω–Ω—è'] && fmtPercent(srCur['–í–∏–∫–æ–Ω–∞–Ω–Ω—è']),
                     srPrev && srPrev['–í–∏–∫–æ–Ω–∞–Ω–Ω—è'] && fmtPercent(srPrev['–í–∏–∫–æ–Ω–∞–Ω–Ω—è'])],
    ].map(([k,cv,pv])=>`<div class="metric"><div class="k">${esc(k)}</div><div class="v">${esc(cv??'0')}</div>${deltaTag(cv,pv)}</div>`).join('');

    // –°—É–º–º—ã –æ–ø–µ—Ä–∞—Ü–∏–π
    const rowsSPcur = (cur.SP||[]).filter(r=>norm(r[cur.mapSP['TERRITORY']||'TERRITORY'])===t);
    const rowsSLcur = (cur.SELLER||[]).filter(r=>norm(r[cur.mapSeller['TERRITORY']])===t);
    const sumsCur = {};
    OPS_CANON.forEach(k=>{
      const colSP=cur.mapSP[k], colSL=cur.mapSeller[k];
      let total=0; const useSP = colSP && rowsSPcur.some(r=>norm(r[colSP])!=='');
      if(useSP) rowsSPcur.forEach(r=> total += toNum(r[colSP])); else if(colSL) rowsSLcur.forEach(r=> total += toNum(r[colSL]));
      sumsCur[k]=total;
    });

    let sumsPrev=null;
    if(prev && prev.SELLER){
      const rowsSPprev=(prev.SP||[]).filter(r=>norm(r[prev.mapSP['TERRITORY']||'TERRITORY'])===t);
      const rowsSLprev=(prev.SELLER||[]).filter(r=>norm(r[prev.mapSeller['TERRITORY']])===t);
      sumsPrev={};
      OPS_CANON.forEach(k=>{
        const colSP=prev.mapSP[k], colSL=prev.mapSeller[k]; let total=0;
        const useSP = colSP && rowsSPprev.some(r=>norm(r[colSP])!=='');
        if(useSP) rowsSPprev.forEach(r=> total += toNum(r[colSP])); else if(colSL) rowsSLprev.forEach(r=> total += toNum(r[colSL]));
        sumsPrev[k]=total;
      });
    }

    const labelsTer = OPS_CANON.map(k=>cur.mapSP[k] || cur.mapSeller[k]).filter(Boolean);
    terOps.innerHTML = labelsTer.map(label=>{
      const canon = cur.revSP[label] || cur.revSeller[label] || label;
      const cv = sumsCur[canon] ?? 0; const pv = sumsPrev? sumsPrev[canon] : null;
      return `<div class="metric"><div class="k">${esc(label)}</div><div class="v">${esc(fmtInt(cv))}</div>${deltaTag(cv,pv)}</div>`;
    }).join('');

    terBox.style.display='';
  }

  function showPos(t,p){
    const {cur,prev} = DS;
    terBox.style.display='none'; resEmpty.style.display='none'; posBox.style.display=''; numBox.style.display='none';
    posCap.textContent = `${t||'‚Äî'} ‚Ä¢ ${p||'‚Äî'}`;

    const spRowCur = (cur.SP||[]).find(r=>norm(r[cur.mapSP['TERRITORY']||'TERRITORY'])===t && norm(r[cur.mapSP['POS NAME']||'POS NAME'])===p) || null;
    const activeVal = spRowCur? norm(spRowCur[cur.mapSP['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç']||'–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç']) : '';
    posPill.style.display = (activeVal==='1'||activeVal==='true'||activeVal==='1.0') ? '' : 'none';

    // Fallback —Å—É–º–º—ã –ø–æ —Ç–æ—á–∫–µ (—Ç–µ–∫—É—â–∏–µ)
    const rowsCur = (cur.SELLER||[]).filter(r=>norm(r[cur.mapSeller['TERRITORY']])===t && norm(r[cur.mapSeller['POS NAME']])===p);
    const fbSumsCur = sumByCanon(rowsCur, cur.mapSeller, OPS_CANON);

    // –ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
    let spRowPrev=null, fbSumsPrev=null;
    if(prev && prev.SELLER){
      spRowPrev = (prev.SP||[]).find(r=>norm(r[prev.mapSP['TERRITORY']||'TERRITORY'])===t && norm(r[prev.mapSP['POS NAME']||'POS NAME'])===p) || null;
      const rowsPrev = prev.SELLER.filter(r=>norm(r[prev.mapSeller['TERRITORY']])===t && norm(r[prev.mapSeller['POS NAME']])===p);
      fbSumsPrev = sumByCanon(rowsPrev, prev.mapSeller, OPS_CANON);
    }

    const labels = cur.mapSP && Object.keys(cur.mapSP).length
      ? labelsFromMap(cur.mapSP, {excludeMobile:true, insertStrongSecond:true})
      : labelsFromMap(cur.mapSeller, {excludeMobile:true, insertStrongSecond:true});

    renderByLabelsWithPrev(
      posMetrics,
      labels,
      (label)=>{ // current
        if(spRowCur && Object.hasOwn(spRowCur,label)){ const v=norm(spRowCur[label]); if(v!=='') return v; }
        const canon = cur.revSP[label] || cur.revSeller[label] || label;
        return fmtInt(fbSumsCur[canon] || 0);
      },
      (canon)=>{ // prev
        if(!prev || !prev.SELLER) return null;
        const colPrev = prev.mapSP[canon];
        if(spRowPrev && colPrev && norm(spRowPrev[colPrev])!=='') return norm(spRowPrev[colPrev]);
        return fmtInt((fbSumsPrev && fbSumsPrev[canon]) || 0);
      },
      cur.revSP && Object.keys(cur.revSP).length? cur.revSP : cur.revSeller,
      true
    );

    posWarn.style.display = spRowCur ? 'none' : '';
  }

  function showNum(row){
    const {cur,prev} = DS; if(!row) return;
    resEmpty.style.display='none'; posBox.style.display='none'; numBox.style.display='';

    const NUM = cur.mapSeller['MOBILE_NUMBER'], TERR=cur.mapSeller['TERRITORY'], POS=cur.mapSeller['POS NAME'];
    const mobile = norm(row[NUM]); elMobile.textContent = mobile || '‚Äî';

    // –Ω–∞–π—Ç–∏ –ø—Ä–æ—à–ª—ã–π –ø–æ —Ç–µ–º –∂–µ TERR+POS+MOBILE
    let rowPrev=null;
    if(prev && prev.SELLER){
      rowPrev = prev.SELLER.find(r=> norm(r[prev.mapSeller['TERRITORY']])===norm(row[TERR]) &&
                                     norm(r[prev.mapSeller['POS NAME']])===norm(row[POS]) &&
                                     norm(r[prev.mapSeller['MOBILE_NUMBER']])===mobile ) || null;
    }

    const labels = labelsFromMap(cur.mapSeller, {excludeMobile:true});
    renderByLabelsWithPrev(
      numMetrics,
      labels,
      (label)=> norm(row[label]||''),
      (canon)=>{ if(!rowPrev) return null; const colPrev = prev.mapSeller[canon]; return colPrev? norm(rowPrev[colPrev]) : null; },
      cur.revSeller,
      true
    );
  }

  // === —Å–µ–ª–µ–∫—Ç—ã ===
  function rebuildTerritory(){
    const {cur}=DS; if(!cur.SELLER) return;
    const TERR = cur.mapSeller['TERRITORY'];
    const terrs = uniqSorted(cur.SELLER.map(r=>norm(r[TERR])));
    selT.innerHTML = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</option>'].concat(terrs.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`)).join('');
    selT.disabled = terrs.length===0;
    selP.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ TERRITORY</option>'; selP.disabled = true;
    selM.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME</option>'; selM.disabled = true;
    showEmpty();
  }

  function rebuildPos(){
    const {cur,prev}=DS; const t = norm(selT.value); if(!t) return;
    const TERR = cur.mapSeller['TERRITORY'], POS = cur.mapSeller['POS NAME'];
    const list = uniqSorted(cur.SELLER.filter(r=>norm(r[TERR])===t).map(r=>norm(r[POS])));

    // –ê–∫—Ç–∏–≤–Ω—ã–µ –¢–¢ (—Å–Ω–∞—á–∞–ª–∞ cur.SP, –∏–Ω–∞—á–µ prev.SP)
    const activeSet = new Set();
    (cur.SP||[]).forEach(r=>{ if(norm(r[cur.mapSP['TERRITORY']||'TERRITORY'])===t && (norm(r[cur.mapSP['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç']||'–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='1'||norm(r[cur.mapSP['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç']||'–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='true')) activeSet.add(norm(r[cur.mapSP['POS NAME']||'POS NAME'])); });
    if(!activeSet.size && prev && prev.SP){
      prev.SP.forEach(r=>{ if(norm(r[prev.mapSP['TERRITORY']||'TERRITORY'])===t && (norm(r[prev.mapSP['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç']||'–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='1'||norm(r[prev.mapSP['–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç']||'–ê–∫—Ç–∏–≤–Ω–∞ —Ç—Ç'])==='true')) activeSet.add(norm(r[prev.mapSP['POS NAME']||'POS NAME'])); });
    }

    // ORG ID (cur.SP –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –∑–∞—Ç–µ–º prev.SP, –∑–∞—Ç–µ–º Seller)
    const items = list.map(p=>{
      let org='';
      let r = (cur.SP||[]).find(r=>norm(r[cur.mapSP['TERRITORY']||'TERRITORY'])===t && norm(r[cur.mapSP['POS NAME']||'POS NAME'])===p);
      if(r) org = norm(r[cur.mapSP['ORG ID']||'ORG ID']);
      if(!org && prev && prev.SP){
        r = prev.SP.find(r=>norm(r[prev.mapSP['TERRITORY']||'TERRITORY'])===t && norm(r[prev.mapSP['POS NAME']||'POS NAME'])===p);
        if(r) org = norm(r[prev.mapSP['ORG ID']||'ORG ID']);
      }
      if(!org){ const rs = cur.SELLER.find(r=>norm(r[TERR])===t && norm(r[POS])===p); org = rs? norm(rs[cur.mapSeller['ORG ID']||'ORG ID']) : ''; }
      const label = (activeSet.has(p)? 'üü¢ ' : '') + p + (org? ' ‚Äî ' + org : '');
      return { value:p, label };
    });

    selP.innerHTML = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É</option>'].concat(items.map(o=>`<option value="${esc(o.value)}">${esc(o.label)}</option>`)).join('');
    selP.disabled = items.length===0;
    selM.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ POS NAME</option>'; selM.disabled = true;

    showTerritory(t);
    posBox.style.display='none'; numBox.style.display='none'; resEmpty.style.display='none';
  }

  function rebuildMobile(){
    const {cur}=DS; const t = norm(selT.value), p = norm(selP.value);
    terBox.style.display='none';
    const TERR=cur.mapSeller['TERRITORY'], POS=cur.mapSeller['POS NAME'], NUM=cur.mapSeller['MOBILE_NUMBER'];
    const FN=cur.mapSeller['First Name']||'First Name', LN=cur.mapSeller['Last Name']||'Last Name';

    const map = new Map();
    cur.SELLER.forEach(r=>{
      if(norm(r[TERR])===t && norm(r[POS])===p){
        const num = norm(r[NUM]); if(!num) return;
        const name = [norm(r[FN]), norm(r[LN])].filter(Boolean).join(' ').trim();
        map.set(num, name? `${num} ‚Äî ${name}` : num);
      }
    });
    const items = Array.from(map.entries()).map(([value,label])=>({value,label})).sort((a,b)=>a.label.localeCompare(b.label,'uk',{numeric:true}));
    selM.innerHTML = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä</option>'].concat(items.map(o=>`<option value="${esc(o.value)}">${esc(o.label)}</option>`)).join('');
    selM.disabled = items.length===0;

    if(p) showPos(t,p); else posBox.style.display='none';
  }

  function onSelectChanged(){
    const {cur}=DS; const t = norm(selT.value), p = norm(selP.value), m = norm(selM.value);
    if(!t||!p||!m) return;
    const NUM=cur.mapSeller['MOBILE_NUMBER'], TERR=cur.mapSeller['TERRITORY'], POS=cur.mapSeller['POS NAME'];
    const row = cur.SELLER.find(r=>norm(r[TERR])===t && norm(r[POS])===p && norm(r[NUM])===m) || null;
    showNum(row);
  }

  selT.addEventListener('change', rebuildPos);
  selP.addEventListener('change', rebuildMobile);
  selM.addEventListener('change', onSelectChanged);

  btnReset.addEventListener('click', ()=>{ if(!DS.cur.SELLER) return; rebuildTerritory(); });

  // === –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–æ—Ä–Ω—è ===
  btnReload.addEventListener('click', loadFromRoot);

  async function fetchRoot(url){
    const res = await fetch(url+`?v=${Date.now()}`, {cache:'no-store'});
    if(!res.ok) throw new Error(`${url} (HTTP ${res.status})`);
    return XLSX.read(await res.arrayBuffer(), { type:'array' });
  }

  function loadIntoDS(which, wb){
    const out={};
    const getSheet = name => (wb.SheetNames||[]).find(n=>String(n).trim().toLowerCase()===name);
    // Seller
    const sName = getSheet('seller'); if(!sName) throw new Error(`[${which}] –Ω–µ—Ç –ª–∏—Å—Ç–∞ 'Seller'`);
    out.SELLER = XLSX.utils.sheet_to_json(wb.Sheets[sName], {defval:''});
    if(!out.SELLER.length) throw new Error(`[${which}] –ª–∏—Å—Ç 'Seller' –ø—É—Å—Ç`);
    out.mapSeller = buildMap(Object.keys(out.SELLER[0]||{})); out.revSeller = invertMap(out.mapSeller);
    ['TERRITORY','POS NAME','MOBILE_NUMBER'].forEach(k=>{ if(!out.mapSeller[k]) throw new Error(`[${which}] –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ ${k} –≤ Seller`); });
    // SalePoint
    const spName = getSheet('salepoint');
    if(spName){ out.SP = XLSX.utils.sheet_to_json(wb.Sheets[spName], {defval:''}); out.mapSP = buildMap(Object.keys(out.SP[0]||{})); out.revSP = invertMap(out.mapSP); }
    else { out.SP=[]; out.mapSP={}; out.revSP={}; }
    // SR
    const srName = getSheet('sr'); out.SR = srName ? XLSX.utils.sheet_to_json(wb.Sheets[srName], {defval:''}) : [];
    DS[which]=out;
  }

  async function loadFromRoot(){
    try{
      elErr.textContent=''; elStat.textContent='–ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª—ã –∏–∑ –∫–æ—Ä–Ω—è‚Ä¶';
      const wbCur = await fetchRoot(ROOT_CUR);  loadIntoDS('cur', wbCur);
      try{ const wbPrev = await fetchRoot(ROOT_PREV); loadIntoDS('prev', wbPrev); elStat.textContent='–û–±–∞ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'; }
      catch(e){ DS.prev={SELLER:[],SP:[],SR:[],mapSeller:{},mapSP:{},revSeller:{},revSP:{}}; elStat.textContent='–ó–∞–≥—Ä—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π (/seller.xlsx)'; }
      setRowsCount();
      rebuildTerritory();
    }catch(e){
      console.error(e); showError(e.message||'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); elStat.textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      selT.innerHTML = '<option value="">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª(—ã)</option>'; selT.disabled=true;
    }
  }

  // –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç
  if(location.protocol==='file:'){
    elStat.textContent='–≠—Ç–∞ –≤–µ—Ä—Å–∏—è —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ http(s):// –∏–∑ –∫–æ—Ä–Ω—è –¥–æ–º–µ–Ω–∞.';
  } else {
    loadFromRoot();
  }
</script>
</body>
</html>
